version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: artifex-postgres
    environment:
      POSTGRES_USER: artifex
      POSTGRES_PASSWORD: artifex_dev_password
      POSTGRES_DB: artifex
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - artifex-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U artifex"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ Message Broker (for MassTransit event bus)
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: artifex-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: artifex
      RABBITMQ_DEFAULT_PASS: artifex_dev_password
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - artifex-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Consul Service Discovery
  consul:
    image: consul:latest
    container_name: artifex-consul
    command: agent -server -bootstrap-expect=1 -ui -client=0.0.0.0
    environment:
      CONSUL_BIND_INTERFACE: eth0
    ports:
      - "8500:8500"   # HTTP API and UI
      - "8600:8600/udp" # DNS
    volumes:
      - consul_data:/consul/data
    networks:
      - artifex-network
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Device Management Service
  device-management:
    build:
      context: .
      dockerfile: src/services/device-management/artifex.device-management.ui.web/api/Dockerfile
    container_name: artifex-device-management
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5001
      - ConnectionStrings__DeviceManagementDb=Host=postgres;Database=artifex_device_management;Username=artifex;Password=artifex_dev_password
      # MassTransit RabbitMQ configuration
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Port=5672
      - RabbitMQ__Username=artifex
      - RabbitMQ__Password=artifex_dev_password
      - RabbitMQ__VirtualHost=/
      # Consul configuration
      - Consul__Enabled=true
      - Consul__Address=http://consul:8500
      - Consul__ServiceAddress=device-management
      - Consul__ServicePort=5001
    ports:
      - "5001:5001"
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      consul:
        condition: service_healthy
    networks:
      - artifex-network
    restart: unless-stopped

  # Node Agent 1 (for local site)
  node-agent-1:
    build:
      context: .
      dockerfile: src/applications/node-agent/artifex.node-agent.ui.web/api/Dockerfile
    container_name: artifex-node-agent-1
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5003
      - NodeAgent__NodeId=node-agent-local-001
      - NodeAgent__DeviceManagementServiceUrl=http://device-management:5001
      - Discovery__InitialDelaySeconds=30
      - Discovery__CheckIntervalMinutes=5
      - Discovery__DefaultUsername=admin
      - Discovery__DefaultPassword=change_me_in_production
      - Discovery__NetworkSegments__0__Name=Local LAN
      - Discovery__NetworkSegments__0__NetworkCidr=192.168.1.0/24
      - Discovery__NetworkSegments__0__Description=Main office network
      - Discovery__NetworkSegments__0__EnableAutoDiscovery=true
      - Discovery__NetworkSegments__0__DiscoveryIntervalMinutes=60
    ports:
      - "5003:5003"
    depends_on:
      - device-management
    networks:
      - artifex-network
    restart: unless-stopped
    # Note: For production, use host network mode to scan local networks
    # network_mode: host

  # Node Agent 2 (for remote site example)
  node-agent-2:
    build:
      context: .
      dockerfile: src/applications/node-agent/artifex.node-agent.ui.web/api/Dockerfile
    container_name: artifex-node-agent-2
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5003
      - NodeAgent__NodeId=node-agent-remote-001
      - NodeAgent__DeviceManagementServiceUrl=http://device-management:5001
      - Discovery__InitialDelaySeconds=45
      - Discovery__CheckIntervalMinutes=10
      - Discovery__DefaultUsername=admin
      - Discovery__DefaultPassword=change_me_in_production
      - Discovery__NetworkSegments__0__Name=Remote Office LAN
      - Discovery__NetworkSegments__0__NetworkCidr=10.0.1.0/24
      - Discovery__NetworkSegments__0__Description=Remote office network
      - Discovery__NetworkSegments__0__EnableAutoDiscovery=true
      - Discovery__NetworkSegments__0__DiscoveryIntervalMinutes=120
    ports:
      - "5004:5003"
    depends_on:
      - device-management
    networks:
      - artifex-network
    restart: unless-stopped

networks:
  artifex-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  rabbitmq_data:
    driver: local
  consul_data:
    driver: local
